# AI Generation Files Overview

This document outlines all the files involved in the AI video generation process.

## Core AI Generation Files

### 1. `lib/runway.ts` ⭐ **MAIN AI FILE**
**Purpose**: Handles all Runway API interactions and prompt generation

**Key Functions:**
- `generateVideo(request)` - Creates video generation task with Runway SDK
  - Uses Runway SDK: `client.imageToVideo.create()`
  - Parameters sent to Runway:
    - `model`: `gen4_turbo` (from `RUNWAY_MODEL_ID` env var)
    - `promptImage`: The uploaded pet image URL
    - `promptText`: The generated dance prompt
    - `duration`: 8 seconds (default)
    - `ratio`: `'1280:720'` (16:9 landscape) - **HARDCODED**
  
- `generateDancePrompt(danceStyle, petDescription)` - Creates the text prompt
  - **Currently using simple template** (OpenAI integration is commented out)
  - Uses `styleDescriptions` object for dance style descriptions
  - Returns a template string like: `"A pet (description) performing the Macarena..."`
  
- `checkVideoStatus(videoId)` - Polls Runway API for video completion

**Current Configuration:**
- Model: `gen4_turbo` (line 34)
- Duration: 8 seconds (line 94, 152)
- Ratio: `'1280:720'` - **HARDCODED** (line 95)
- Prompt: Simple template (lines 275-290)

**Potential Quality Issues:**
- ❌ Simple prompt template (not using OpenAI for better prompts)
- ❌ Fixed aspect ratio (might not match input image)
- ❌ No prompt optimization for pet dancing
- ❌ Duration is fixed at 8 seconds

---

### 2. `app/api/videos/generate/route.ts`
**Purpose**: API endpoint that orchestrates video generation

**Flow:**
1. Validates user and credits
2. Calls `generateDancePrompt()` to create prompt (line 61)
3. Creates video record in database
4. Calls `generateVideo()` from `lib/runway.ts` (line 149)
5. Saves `runway_video_id` to database

**Key Parameters Passed:**
- `imageUrl`: From user upload
- `prompt`: Generated by `generateDancePrompt()`
- `duration`: 8 seconds (hardcoded, line 152)

---

### 3. `lib/dance-styles.ts`
**Purpose**: Defines available dance styles

**Contains:**
- `DANCE_STYLES` array with dance style definitions
- Each style has: `id`, `name`, `description`, `emoji`
- Used by `generateDancePrompt()` to get style descriptions

**Dance Styles Available:**
- macarena, salsa, hip_hop, robot, ballet, disco, breakdance, waltz, tango, cha_cha

---

## Configuration Files

### 4. `env.local` / Environment Variables
**Relevant Variables:**
- `RUNWAY_API_KEY` - Runway API authentication
- `RUNWAY_MODEL_ID` - Model to use (default: `gen4_turbo`)
- `OPENAI_API_KEY` - For prompt enhancement (currently not used)

---

## Current AI Generation Flow

```
User uploads image + selects dance style
    ↓
app/api/videos/generate/route.ts
    ↓
generateDancePrompt() in lib/runway.ts
    ↓ (creates simple template prompt)
generateVideo() in lib/runway.ts
    ↓
Runway SDK: client.imageToVideo.create({
    model: 'gen4_turbo',
    promptImage: <imageUrl>,
    promptText: <simple template>,
    duration: 8,
    ratio: '1280:720'
})
    ↓
Runway generates video
    ↓
Status polling via checkVideoStatus()
```

---

## Areas That Affect Video Quality

### 1. **Prompt Quality** (`lib/runway.ts` lines 232-291)
**Current State:**
- Using simple template strings
- OpenAI integration is commented out (lines 245-272)
- Basic style descriptions from `styleDescriptions` object

**Example Current Prompt:**
```
"A pet (description) performing the Macarena with coordinated arm movements and hip sways. 
The pet's face, features, and identity are clearly preserved throughout the video. 
The dance movements are smooth, natural, and match the macarena style accurately. 
Professional video quality, well-lit environment, stable camera, 8-10 second duration."
```

**Potential Improvements:**
- Enable OpenAI prompt generation (already coded, just commented out)
- Add more detailed dance movement descriptions
- Include pet-specific instructions (preserve face, maintain identity)
- Add quality keywords (high quality, detailed, smooth motion)

---

### 2. **Runway API Parameters** (`lib/runway.ts` lines 90-96)
**Current Settings:**
```typescript
{
  model: 'gen4_turbo',
  promptImage: request.imageUrl,
  promptText: request.prompt,
  duration: 8,  // Fixed
  ratio: '1280:720'  // Fixed - might not match input image
}
```

**Potential Issues:**
- **Fixed ratio** might crop/distort the input image
- **Duration** is fixed at 8 seconds
- **No seed** parameter for consistency
- **No content moderation settings**

**Available Options (from SDK types):**
- `ratio`: '1280:720', '720:1280', '1104:832', '832:1104', '960:960', '1584:672'
- `duration`: number (for gen4_turbo)
- `seed`: number (for reproducibility)
- `contentModeration`: object (for safety settings)

---

### 3. **Model Selection** (`lib/runway.ts` line 34)
**Current:** `gen4_turbo`

**Other Available Models (from SDK):**
- `gen3a_turbo` - Older model
- `veo3.1` - Different model with different parameters
- `veo3.1_fast` - Faster version
- `veo3` - Another variant

---

## Files Summary

| File | Purpose | Key Impact on Quality |
|------|---------|----------------------|
| `lib/runway.ts` | **Main AI logic** | ⭐⭐⭐ Prompt quality, API parameters |
| `app/api/videos/generate/route.ts` | API orchestration | ⭐ Passes parameters correctly |
| `lib/dance-styles.ts` | Dance style definitions | ⭐ Provides style descriptions |
| `env.local` | Configuration | ⭐ Model selection, API keys |

---

## Quick Reference: Where to Make Changes

### To Improve Prompt Quality:
**File:** `lib/runway.ts`
- **Lines 232-291**: `generateDancePrompt()` function
- **Lines 245-272**: Uncomment OpenAI integration
- **Lines 275-286**: Improve `styleDescriptions` object

### To Change Video Parameters:
**File:** `lib/runway.ts`
- **Line 34**: Change model (`RUNWAY_MODEL_ID`)
- **Line 95**: Change aspect ratio
- **Line 94**: Change duration
- **Lines 90-96**: Add more parameters (seed, contentModeration)

### To Add New Dance Styles:
**File:** `lib/dance-styles.ts`
- **Lines 12-73**: Add to `DANCE_STYLES` array
- **File:** `lib/runway.ts`
- **Lines 275-286**: Add to `styleDescriptions` object

---

## Next Steps for Quality Improvement

1. **Enable OpenAI prompt generation** (already coded, just needs uncommenting)
2. **Improve prompt templates** with more specific dance instructions
3. **Match aspect ratio** to input image (or detect automatically)
4. **Add seed parameter** for consistency
5. **Experiment with different models** (veo3.1, etc.)
6. **Add negative prompts** (if Runway supports them)
7. **Optimize duration** based on dance style

